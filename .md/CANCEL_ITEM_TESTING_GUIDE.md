# วิธีการทดสอบการยกเลิกสินค้าบางส่วน (Partial Item Cancellation)

## 📋 ขั้นตอนการเตรียมระบบ

### ขั้นตอนที่ 1: ตรวจสอบและตั้งค่าฐานข้อมูล
ก่อนทดสอบ ต้องแน่ใจว่าระบบได้เพิ่มคอลัมน์ที่จำเป็นแล้ว

1. **เปิด URL นี้ในเบราว์เซอร์:**
   ```
   http://localhost/IchoicePMS---Copy/setup_cancel_columns.php
   ```

2. **ตรวจสอบผลลัพธ์:** ควรเห็นสถานะ ✓ สำหรับคอลัมน์ทั้ง 5 หรือหากมีอยู่แล้ว ก็จะแสดง "Column already exists"
   - ✓ is_cancelled
   - ✓ cancelled_by
   - ✓ cancelled_at
   - ✓ cancel_reason
   - ✓ cancel_notes

3. **ถ้าเห็น ✗ ให้ตรวจสอบ:**
   - สิทธิ์การเข้าถึงฐานข้อมูล
   - ไฟล์ logs/ มีสิทธิ์เขียน

---

## 🧪 ขั้นตอนการทดสอบ (Testing Steps)

### ขั้นตอนที่ 2: ตรวจสอบระบบแบบรวม
1. **เปิด URL นี้เพื่อทดสอบระบบทั้งหมด:**
   ```
   http://localhost/IchoicePMS---Copy/test_receive_system.php
   ```

2. **ตรวจสอบผลลัพธ์:**
   ```
   ✓ Database connected successfully
   ✓ Test PO: {"po_id": X, "po_number": "PO-2025-XXXXX"}
   ✓ API endpoint: http://localhost/IchoicePMS---Copy/api/get_po_items.php?po_id=X
   ✓ Cancel columns in purchase_order_items: 5 ✓
   ✓ activity_logs table exists
   ```

---

### ขั้นตอนที่ 3: ทดสอบการยกเลิกสินค้า - วิธีการใช้งาน

#### **3.1 เข้าสู่ระบบรับสินค้า**
1. เปิด: `http://localhost/IchoicePMS---Copy/receive/receive_po_items.php`
2. เข้าสู่ระบบด้วยบัญชีผู้ใช้ของคุณ

#### **3.2 เลือกใบ PO ที่ต้องการทดสอบ**
1. ในหน้า "สินค้าใบสั่งซื้อที่รอการรับ" 
2. ค้นหา PO ที่มีสถานะ "pending" หรือ "partial" 
3. คลิกปุ่ม <button>รับสินค้า</button> (สีฟ้า)

#### **3.3 ทดสอบการยกเลิกสินค้า**
หลังจากคลิก "รับสินค้า" จะเห็นรายการสินค้า:

```
┌─────────────────────────────────────────────────────────┐
│ ชื่อสินค้า    | จำนวน  | ได้รับ | [รับเร็ว] [❌ยกเลิก] │
├─────────────────────────────────────────────────────────┤
│ Product A    │ 100   | 0     | [   ] [  ❌  ]        │
│ Product B    │ 50    | 0     | [   ] [  ❌  ]        │
└─────────────────────────────────────────────────────────┘
```

**การยกเลิก:**
1. **คลิกปุ่ม ❌ (สีแดง)** ที่อยู่ถัดจากปุ่ม "รับเร็ว"
   
2. **หน้าต่างป็อปอัป (Modal) จะปรากฏ:**
   ```
   ┌─────────────────────────────────────────┐
   │    ยกเลิกสินค้า: Product A              │
   ├─────────────────────────────────────────┤
   │ สาเหตุการยกเลิก:                        │
   │ [▼ เลือกสาเหตุ                         ]│
   │   - ไม่ได้รับจากผู้จัดส่ง                  │
   │   - คุณภาพไม่ดี                       │
   │   - สินค้าเสียหาย                      │
   │   - ขอเปลี่ยนสินค้า                     │
   │   - ยกเลิกตามคำขอ                       │
   │   - อื่นๆ                              │
   │                                         │
   │ หมายเหตุ:                               │
   │ [                                       ]│
   │ [                                       ]│
   │ [                                       ]│
   │                                         │
   │        [ยกเลิก]  [ปิด]                  │
   └─────────────────────────────────────────┘
   ```

3. **กรอกข้อมูล:**
   - เลือกสาเหตุจากลิสต์ (dropdown)
   - (ตัวเลือก) เพิ่มหมายเหตุเพิ่มเติม
   - คลิก **[ยกเลิก]** เพื่อยืนยัน

4. **ยืนยันการยกเลิก:**
   ```
   Are you sure you want to cancel this item?
   [Cancel]  [Yes, Cancel Item]
   ```
   - คลิก **[Yes, Cancel Item]** เพื่อยืนยัน

---

## ✅ วิธีการตรวจสอบผลการทดสอบ

### วิธีที่ 1: ตรวจสอบจากหน้า Receive Items
1. หลังจากยกเลิกสินค้า หน้าจะรีเฟรชอัตโนมัติ
2. **สินค้าที่ยกเลิกแล้วจะหายไปจากลิสต์** หรือแสดงสถานะ "ยกเลิกแล้ว"

### วิธีที่ 2: ตรวจสอบจากฐานข้อมูลโดยตรง
เปิด phpMyAdmin หรือเครื่องมือจัดการฐานข้อมูล:

```sql
-- ค้นหาสินค้าที่ยกเลิก
SELECT 
    item_id,
    po_id,
    product_id,
    qty,
    is_cancelled,
    cancelled_by,
    cancelled_at,
    cancel_reason,
    cancel_notes
FROM purchase_order_items
WHERE is_cancelled = 1
ORDER BY cancelled_at DESC
LIMIT 10;
```

**ผลลัพธ์ที่คาดหวัง:**
```
item_id | po_id | qty | is_cancelled | cancel_reason           | cancelled_at
--------|-------|-----|--------------|------------------------|-----------------------
5       | 13    | 100 | 1            | ไม่ได้รับจากผู้จัดส่ง    | 2025-12-03 10:30:45
```

### วิธีที่ 3: ตรวจสอบ Activity Log
```sql
-- ดูประวัติการยกเลิก
SELECT 
    log_id,
    user_id,
    action,
    table_name,
    record_id,
    timestamp,
    details
FROM activity_logs
WHERE action = 'cancel_item'
ORDER BY timestamp DESC
LIMIT 10;
```

**ผลลัพธ์ที่คาดหวัง:**
```
log_id | user_id | action      | table_name           | record_id | details
-------|---------|-------------|----------------------|-----------|----------------------------
100    | 1       | cancel_item | purchase_order_items | 5         | {"reason": "ไม่ได้รับจากผู้จัดส่ง"}
```

---

## 🎯 การทดสอบแบบละเอียด (Detailed Test Cases)

### Test Case 1: ยกเลิกสินค้า 1 รายการ
**ขั้นตอน:**
1. เปิดใบ PO ที่มี 3+ รายการสินค้า
2. ยกเลิกรายการแรก
3. ตรวจสอบว่ารายการอื่นๆ ยังอยู่ปกติ

**ผลลัพธ์คาดหวัง:**
- ✓ สินค้าที่ยกเลิกหายจากลิสต์
- ✓ สินค้าอื่นยังสามารถรับได้ปกติ
- ✓ ข้อมูลถูกบันทึกในฐานข้อมูล

### Test Case 2: ยกเลิกหลายรายการจากใบเดียว
**ขั้นตอน:**
1. เปิดใบ PO ที่มี 4+ รายการ
2. ยกเลิกรายการที่ 1
3. ยกเลิกรายการที่ 3
4. ตรวจสอบสินค้าที่เหลือ

**ผลลัพธ์คาดหวัง:**
- ✓ สินค้า 1, 3 ถูกยกเลิก
- ✓ สินค้า 2, 4 ยังสามารถรับได้
- ✓ ทั้งสองการยกเลิกบันทึกเป็นแยกต่างหาก

### Test Case 3: ยกเลิกกับสาเหตุต่างๆ
**ขั้นตอน:**
1. ยกเลิกสินค้า 1 ด้วยสาเหตุ "ไม่ได้รับจากผู้จัดส่ง"
2. ยกเลิกสินค้า 2 ด้วยสาเหตุ "คุณภาพไม่ดี"
3. ยกเลิกสินค้า 3 ด้วยสาเหตุ "อื่นๆ" + หมายเหตุ "สินค้าสั่งเกินจำนวน"

**ผลลัพธ์คาดหวัง:**
- ✓ ทั้ง 3 รายการถูกยกเลิก
- ✓ สาเหตุแต่ละรายการบันทึกถูกต้อง
- ✓ หมายเหตุของรายการที่ 3 บันทึกเป็น "สินค้าสั่งเกินจำนวน"

### Test Case 4: ยกเลิกแล้วพยายามรับสินค้านั้นอีก
**ขั้นตอน:**
1. ยกเลิกสินค้า A
2. รีเฟรชหน้า
3. ลองค้นหาสินค้า A ในลิสต์

**ผลลัพธ์คาดหวัง:**
- ✓ สินค้า A หายไปจากลิสต์
- ✓ ไม่สามารถรับสินค้า A ได้อีก

---

## 🐛 การแก้ไขปัญหาทั่วไป

### ปัญหา: ปุ่ม "ยกเลิก" ไม่ตอบสนอง (ไม่มีอะไรเกิดขึ้น)
**สาเหตุ:** JavaScript ไม่โหลด หรือ Event Delegation ไม่ทำงาน

**วิธีแก้:**
1. เปิด Developer Console (F12 → Console)
2. ดูว่ามีข้อผิดพลาด (error) หรือไม่
3. รีเฟรชหน้า (Ctrl+F5)

**ตรวจสอบใน Console:**
```javascript
// ควรเห็นหมายเลขอย่างน้อย 1 รายการ
$('.cancel-item-btn').length
```

### ปัญหา: Modal ปรากฏแต่ปุ่ม "ยกเลิก" ไม่ทำงาน
**สาเหตุ:** AJAX ล้มเหลว หรือ API ไม่ตอบสนอง

**วิธีแก้:**
1. เปิด Network Tab (F12 → Network)
2. คลิก "ยกเลิก"
3. ดูว่า Request ถึง `process_receive_po.php` หรือไม่
4. ตรวจสอบ Response (ควรเป็น JSON)

### ปัญหา: "Database columns missing" ในการทดสอบ
**สาเหตุ:** ยังไม่ได้เรียกใช้ `setup_cancel_columns.php`

**วิธีแก้:**
1. เปิด `http://localhost/IchoicePMS---Copy/setup_cancel_columns.php`
2. รอให้โหลดจนกว่าจะเห็นสถานะสำหรับแต่ละคอลัมน์
3. รีเฟรช `test_receive_system.php` อีกครั้ง

---

## 📊 ตารางสรุปการทดสอบ

| Test Case | ขั้นตอน | ผลลัพธ์คาดหวัง | ผลลัพธ์จริง | ✓/✗ |
|-----------|--------|---------------|----------|-----|
| 1. ยกเลิก 1 รายการ | คลิก ❌ → เลือกสาเหตุ → ยืนยัน | สินค้าหายไป | - | - |
| 2. ยกเลิก 2 รายการ | ทำซ้ำ 2 ครั้ง | ทั้ง 2 หายไป | - | - |
| 3. สาเหตุต่างๆ | ยกเลิกกับสาเหตุ 3 ตัว | บันทึกถูกต้อง | - | - |
| 4. ไม่ปรากฏหลังยกเลิก | รีเฟรช → ค้นหา | ไม่เจอ | - | - |

---

## 🔍 ไฟล์ที่เกี่ยวข้อง

| ไฟล์ | วัตถุประสงค์ | สำคัญ |
|------|-----------|------|
| `receive/receive_po_items.php` | UI หลักสำหรับรับสินค้าและยกเลิก | 🔴 |
| `receive/process_receive_po.php` | Backend ที่ประมวลผลการยกเลิก | 🔴 |
| `setup_cancel_columns.php` | ตั้งค่าฐานข้อมูล | 🟠 |
| `test_receive_system.php` | ทดสอบระบบทั้งหมด | 🟠 |
| `api/get_po_items.php` | API ดึงข้อมูลสินค้า | 🟡 |

---

## 📞 หากพบปัญหา

1. **เปิด Browser Console (F12)**
2. **ตรวจสอบข้อความ error** ที่ปรากฏ
3. **รันคำสั่ง SQL** เพื่อตรวจสอบฐานข้อมูล:
   ```sql
   SELECT * FROM purchase_order_items WHERE is_cancelled = 1 LIMIT 5;
   ```
4. **ดู error logs** ในโฟลเดอร์ `logs/`
5. **ติดต่อผู้ดูแลระบบ** ด้วยข้อมูลจากข้างต้น

---

**อัปเดต:** 2025-12-03
**เวอร์ชัน:** 1.0 - Cancel Item Feature Testing
