# การแก้ไขการแสดงรายการสินค้าที่ถูกยกเลิก

## สรุปการเปลี่ยนแปลง

### ไฟล์ที่สร้างใหม่:
1. **`receive/cancelled_items.php`** - หน้าแยกต่างหากสำหรับแสดงรายการสินค้าที่ถูกยกเลิก
2. **`receive/templates_stats_cards.php`** - Template สำหรับแสดง stats cards
3. **`receive/templates_filter_results.php`** - Template สำหรับแสดงผลลัพธ์การกรอง
4. **`api/get_cancelled_items_count.php`** - API สำหรับดึงจำนวนสินค้าที่ยกเลิก

### ไฟล์ที่แก้ไข:
1. **`receive/receive_po_items.php`**
   - แทนที่ stats cards ด้วย Include จากไฟล์ template
   - อัปเดต JavaScript เพื่อให้การกดการ์ด "ยกเลิก" ไปที่หน้า `cancelled_items.php`

## คุณสมบัติใหม่

### หน้า cancelled_items.php
- **Header ที่สวยงาม** - พื้นหลังสีแดงพร้อมปุ่มกลับ
- **Stats Cards** - แสดงสถิติการยกเลิก:
  - รวมรายการที่ยกเลิก
  - ยกเลิกทั้งหมด
  - ยกเลิกบางจำนวน
  - ใบ PO ที่มีการยกเลิก
- **จัดกลุ่มตาม PO** - แสดงสินค้าที่ยกเลิกแบ่งตาม PO
- **รายละเอียดสินค้า** - แสดงข้อมูลครบถ้วน:
  - รหัสสินค้าและชื่อ
  - จำนวนสั่ง จำนวนรับได้ จำนวนยกเลิก
  - ราคาต่อหน่วย
  - ผู้ยกเลิก วันที่ยกเลิก
  - เหตุผลและหมายเหตุ

### Template แยกส่วน
- **templates_stats_cards.php** - ใช้ Include ใน receive_po_items.php
- **templates_filter_results.php** - เตรียมไว้สำหรับฟีเจอร์ขั้นสูง

## วิธีใช้

### ดูรายการสินค้าที่ยกเลิก
1. ไปที่หน้า "รับเข้าสินค้า"
2. กดการ์ด "ยกเลิก" ที่มีจำนวนสินค้าที่ยกเลิก
3. จะเด้งไปหน้า `cancelled_items.php` อัตโนมัติ

### หน้า cancelled_items.php
- แสดงสถิติการยกเลิกทั้งหมด
- จัดกลุ่มตามใบ PO
- แสดงรายละเอียดแต่ละสินค้าที่ยกเลิก
- ปุ่มกลับเพื่อกลับไปหน้า "รับเข้าสินค้า"

## โครงสร้างฐานข้อมูล

### ตารางที่ใช้:
- `purchase_order_items` - ข้อมูลสินค้าในใบ PO
  - `is_cancelled` - ยกเลิกทั้งหมด
  - `is_partially_cancelled` - ยกเลิกบางจำนวน
  - `cancel_qty` - จำนวนที่ยกเลิก
  - `cancel_reason` - เหตุผล
  - `cancel_notes` - หมายเหตุ
  - `cancelled_at` - วันเวลาที่ยกเลิก
  - `cancelled_by` - ID ผู้ยกเลิก

- `purchase_orders` - ข้อมูลใบ PO
- `suppliers` - ข้อมูลผู้จัดส่ง
- `products` - ข้อมูลสินค้า
- `users` - ข้อมูลผู้ใช้ (สำหรับแสดง ผู้ยกเลิก)

## การตั้งค่ากระดับการเข้าถึง

### ความสามารถในการเข้าถึง
- จำเป็นต้อง Login เพื่อเข้าถึงหน้า
- ตรวจสอบ Session `$_SESSION['user_id']`

## การอัปเดตในอนาคต

อาจเพิ่มคุณสมบัติต่อไปนี้:
- ตัวกรองตามวันที่ยกเลิก
- ตัวกรองตามเหตุผล
- ส่วนหมายเหตุเชิงลึก
- ยกเลิกผู้ยกเลิก (ถ้าอนุญาต)
- ส่งออก Excel

## หมายเหตุทางเทคนิค

### Performance
- ใช้ LEFT JOIN เพื่อดึงข้อมูลอย่างมีประสิทธิภาพ
- GROUP BY ตาม PO เพื่อจัดกลุ่มข้อมูล

### Security
- ตรวจสอบ Session ก่อนแสดงข้อมูล
- ใช้ `htmlspecialchars()` เพื่อป้องกัน XSS

### Responsive Design
- ใช้ Bootstrap 5 grid system
- ปรับตัวสำหรับอุปกรณ์โทรศัพท์
