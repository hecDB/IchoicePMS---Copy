# การปรับปรุงเงื่อนไขสถานะสต็อกให้ตรงกับแดชบอร์ด

## วันที่: 13 ตุลาคม 2025

## สรุปการเปลี่ยนแปลง
ปรับปรุงเงื่อนไขการแสดงสถานะสต็อกในหน้า "สินค้าคงคลังทั้งหมด" ให้ตรงกับที่แสดงในแดชบอร์ด

## การเปรียบเทียบเงื่อนไข

### ใน Dashboard.php:
```sql
-- สำหรับสินค้าต่ำ
HAVING total_qty <= 1
```

### ใน all_stock.php:

#### เงื่อนไขก่อนปรับ:
```sql
CASE 
    WHEN COALESCE(SUM(ri.receive_qty), 0) > 10 THEN 'high'
    WHEN COALESCE(SUM(ri.receive_qty), 0) BETWEEN 2 AND 10 THEN 'medium' 
    WHEN COALESCE(SUM(ri.receive_qty), 0) = 1 THEN 'low'
    ELSE 'out'
END as stock_status
```

#### เงื่อนไขหลังปรับ:
```sql
CASE 
    WHEN COALESCE(SUM(ri.receive_qty), 0) > 10 THEN 'high'
    WHEN COALESCE(SUM(ri.receive_qty), 0) BETWEEN 2 AND 10 THEN 'medium' 
    WHEN COALESCE(SUM(ri.receive_qty), 0) <= 1 AND COALESCE(SUM(ri.receive_qty), 0) > 0 THEN 'low'
    ELSE 'out'
END as stock_status
```

## ความเปลี่ยนแปลงที่สำคัญ

### 1. เงื่อนไขสถานะ 'low':
- **เดิม**: `= 1` (เฉพาะที่เหลือ 1 ชิ้นพอดี)
- **ใหม่**: `<= 1 AND > 0` (เหลือ 1 ชิ้นหรือน้อยกว่า แต่มากกว่า 0)

### 2. เงื่อนไขสถิติ:
```sql
-- เดิม
SUM(CASE WHEN total_stock = 1 THEN 1 ELSE 0 END) as low_stock,

-- ใหม่
SUM(CASE WHEN total_stock <= 1 AND total_stock > 0 THEN 1 ELSE 0 END) as low_stock,
```

## ประโยชน์ของการเปลี่ยนแปลง

### 1. ความสอดคล้อง:
- เงื่อนไขใน all_stock.php จะตรงกับ dashboard.php
- การแสดงผลในทุกหน้าจะสม่ำเสมอ

### 2. ความยืดหยุ่น:
- สินค้าที่เหลือเศษ (เช่น 0.5 ชิ้น) จะถูกจัดเป็นสต็อกต่ำ
- รองรับการคำนวณที่อาจมีเศษทศนิยม

### 3. ความแม่นยำ:
- ครอบคลุมกรณีที่สินค้าเหลือ <= 1 ชิ้น ทั้งหมด
- ไม่ครอบคลุมสินค้าที่หมด (0 ชิ้น)

## ผลกระทบต่อการแสดงผล

### สถานการณ์ต่าง ๆ:
- **สินค้าเหลือ 0.5 ชิ้น**: จัดเป็น "สต็อกต่ำ" (เดิม: อาจไม่ถูกจัดประเภท)
- **สินค้าเหลือ 1 ชิ้น**: จัดเป็น "สต็อกต่ำ" (เช่นเดิม)
- **สินค้าเหลือ 0 ชิ้น**: จัดเป็น "หมด" (เช่นเดิม)
- **สินค้าเหลือ 2-10 ชิ้น**: จัดเป็น "สต็อกปานกลาง" (เช่นเดิม)
- **สินค้าเหลือ >10 ชิ้น**: จัดเป็น "สต็อกเพียงพอ" (เช่นเดิม)

## การทดสอบ
- ✅ PHP Syntax Check: ผ่าน
- ✅ Web Page Load: ผ่าน
- ✅ เงื่อนไขตรงกับ Dashboard: ผ่าน
- ✅ Stats Calculation: ปรับปรุงแล้ว

## หมายเหตุ
การปรับปรุงนี้ทำให้ระบบมีความสอดคล้องกันระหว่างหน้าแดชบอร์ดและหน้าสินค้าคงคลัง ช่วยให้ผู้ใช้ไม่สับสนเกี่ยวกับเกณฑ์การจัดประเภทสินค้า