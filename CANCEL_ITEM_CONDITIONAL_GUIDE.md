# การยกเลิกสินค้า - คู่มือเงื่อนไขสองกรณี

## ภาพรวม
ระบบการยกเลิกสินค้า (Cancel Item) ได้รับการอัปเดตเพื่อรองรับสองกรณีหลัก:
1. **ยกเลิกจำนวนทั้งหมด** - ยกเลิกสินค้าและปิด PO เป็น 100% เสร็จสิ้น
2. **ยกเลิกบางจำนวน** - ยกเลิกเฉพาะส่วนหนึ่งและอัปเดตสถานะ PO ตามจำนวนที่ได้รับ

## 1. กรณีที่ 1: ยกเลิกจำนวนทั้งหมด

### ขั้นตอนการทำงาน:
1. ผู้ใช้คลิกปุ่มยกเลิกสินค้า (❌ icon)
2. เลือก **"ยกเลิกจำนวนทั้งหมด"** ในช่อง "ประเภทการยกเลิก"
3. เลือกเหตุผลการยกเลิก
4. กรอกหมายเหตุเพิ่มเติม (ถ้าต้องการ)
5. คลิก "ยืนยันการยกเลิก"

### การปรับเปลี่ยนฐานข้อมูล:
- **สร้าง Receive Record**: ระบบสร้างเรคคอร์ดรับสินค้าด้วยจำนวนเท่ากับ `(ปริมาณที่สั่ง - ปริมาณที่รับแล้ว)` เพื่อให้ครบถ้วน
- **ทำเครื่องหมายเป็นยกเลิก**: อัปเดต `is_cancelled = 1` ในตาราง `purchase_order_items`
- **บันทึกข้อมูล**: บันทึกเหตุผลและผู้ยกเลิกในฐานข้อมูล
- **อัปเดตสถานะ PO**: เปลี่ยนสถานะ PO เป็น **"completed" (สำเร็จ)** - 100%

### ผลลัพธ์:
```
สถานะรับสินค้า: ✅ 100%
สถานะ PO: ✅ Completed (สำเร็จ)
ไม่มีสินค้าค้างในระบบ
```

**ตัวอย่าง:**
- สั่ง: 100 หน่วย
- รับแล้ว: 30 หน่วย
- ยกเลิก: ทั้งหมด
- **ผลลัพธ์**: 
  - สร้าง receive record: 70 หน่วย
  - สถานะรับสินค้า: 100 หน่วย = 100% ✅
  - PO: Completed

---

## 2. กรณีที่ 2: ยกเลิกบางจำนวน

### ขั้นตอนการทำงาน:
1. ผู้ใช้คลิกปุ่มยกเลิกสินค้า (❌ icon)
2. เลือก **"ยกเลิกบางจำนวน"** ในช่อง "ประเภทการยกเลิก"
3. **กรอกจำนวนที่ต้องการยกเลิก** (ช่องจะแสดงขึ้นหลังเลือกประเภท)
   - จำนวนสูงสุดที่สามารถยกเลิก = ปริมาณที่สั่ง
   - ตรวจสอบ: `ปริมาณที่ยกเลิก ≤ ปริมาณที่สั่ง`
4. เลือกเหตุผลการยกเลิก
5. กรอกหมายเหตุเพิ่มเติม (ถ้าต้องการ)
6. คลิก "ยืนยันการยกเลิก"

### การปรับเปลี่ยนฐานข้อมูล:
- **บันทึกจำนวนยกเลิก**: บันทึกจำนวนที่ยกเลิกใน `cancel_qty_reason`
- **ทำเครื่องหมายบางส่วน**: ตั้ง `is_partially_cancelled = 1`
- **บันทึกข้อมูล**: บันทึกเหตุผล, จำนวน, และผู้ยกเลิก

### ตรวจสอบและอัปเดตสถานะ PO:
ระบบจะตรวจสอบหลังจากการยกเลิก:
```
จำนวนที่รับ + จำนวนที่ยกเลิก >= จำนวนที่สั่ง ?
```

**กรณีที่ 2A: ครบตามจำนวนที่สั่ง**
- สถานะ PO → **Completed (สำเร็จ)** - 100%
- ไม่มีสินค้าค้างในระบบ

**กรณีที่ 2B: ยังไม่ครบ**
- สถานะ PO → **Partial (บางส่วน)** 
- มีสินค้าค้างอยู่ในระบบ

### ผลลัพธ์ตัวอย่าง:

**ตัวอย่าง 2A: ยกเลิกแล้วครบตามจำนวน**
```
สั่ง: 100 หน่วย
รับแล้ว: 50 หน่วย
ยกเลิก: 50 หน่วย
─────────────────
รับรวม + ยกเลิก = 50 + 50 = 100 ✅

ผลลัพธ์:
สถานะรับสินค้า: 100%
สถานะ PO: ✅ Completed
ไม่มีค้าง
```

**ตัวอย่าง 2B: ยกเลิกแต่ยังไม่ครบ**
```
สั่ง: 100 หน่วย
รับแล้ว: 50 หน่วย
ยกเลิก: 30 หน่วย
─────────────────
รับรวม + ยกเลิก = 50 + 30 = 80 (ไม่ถึง 100)

ผลลัพธ์:
สถานะรับสินค้า: 80%
สถานะ PO: ⏳ Partial (บางส่วน)
ค้างอยู่: 20 หน่วย
```

---

## 3. อัปเดตส่วนหน้า (UI)

### Modal ใหม่:
```
┌─ ยกเลิกสินค้าจาก PO ─────────────┐
│                                   │
│ สินค้า: [ชื่อสินค้า]              │
│ จำนวนที่สั่ง: 100 | รับแล้ว: 30   │
│                                   │
│ ✓ ประเภทการยกเลิก *              │
│  ○ ยกเลิกจำนวนทั้งหมด            │
│    เลิกการสั่งซื้อและปิด 100%    │
│                                   │
│  ○ ยกเลิกบางจำนวน                │
│    กรอกจำนวนที่ต้องการยกเลิก     │
│    [จำนวนที่ยกเลิก: ___]          │
│    (สูงสุด: 100 หน่วย)           │
│                                   │
│ ✓ เหตุผลการยกเลิก *               │
│  [เลือกเหตุผล]                    │
│                                   │
│ หมายเหตุเพิ่มเติม                  │
│ [_____________________]           │
│                                   │
│ [ยกเลิก]  [ยืนยันการยกเลิก]      │
└─────────────────────────────────┘
```

### ฟิลด์เพิ่มเติม:
- **ประเภทการยกเลิก**: Radio buttons เลือก 1 ในสอง
- **จำนวนที่ยกเลิก**: Input field สำหรับกรณี "บางจำนวน" (ซ่อนโดยค่าเริ่มต้น)
- **การแสดงจำนวน**: แสดงปริมาณสูงสุดที่สามารถยกเลิกได้

### Event Handler:
```javascript
// เมื่อเลือก "ยกเลิกบางจำนวน"
$('.cancel-type-radio').on('change', function() {
    if ($('#cancelTypePartial').is(':checked')) {
        $('#cancelQtyContainer').show();  // แสดงช่องจำนวน
    } else {
        $('#cancelQtyContainer').hide();  // ซ่อนช่องจำนวน
    }
});
```

---

## 4. อัปเดตส่วนหลัง (Backend)

### ไฟล์: `process_receive_po.php`

#### เพิ่มคอลัมน์ฐานข้อมูล:
```sql
is_partially_cancelled TINYINT(1)  -- ทำเครื่องหมายยกเลิกบางส่วน
cancel_qty_reason FLOAT             -- จำนวนที่ยกเลิก
```

#### ตรรกะเมนต์:

**กรณี: cancel_all**
```php
// 1. สร้าง receive record ด้วยจำนวนที่เหลือ
INSERT INTO receive_items 
VALUES ($item_id, $ordered_qty - $received_qty, ...)

// 2. ทำเครื่องหมายเป็นยกเลิก
UPDATE purchase_order_items 
SET is_cancelled = 1, 
    cancel_qty_reason = $ordered_qty
WHERE item_id = $item_id

// 3. อัปเดตสถานะ PO → Completed
```

**กรณี: cancel_partial**
```php
// 1. ตรวจสอบปริมาณ
if ($cancel_qty > $ordered_qty) throw error

// 2. บันทึกจำนวนยกเลิก
UPDATE purchase_order_items 
SET is_partially_cancelled = 1,
    cancel_qty_reason = $cancel_qty
WHERE item_id = $item_id

// 3. ตรวจสอบสถานะ:
if ($received_qty + $cancel_qty >= $ordered_qty) {
    // Completed
} else {
    // Partial
}
```

#### ฟังก์ชัน `updatePOStatus()`:
```php
// ตรวจสอบทุกรายการใน PO
$completed_items = COUNT(
    WHERE received_qty >= ordered_qty OR 
    (received_qty + cancel_qty_reason >= ordered_qty)
)

if ($completed_items >= $total_items) {
    status = 'completed'  // PO สำเร็จ
} else if ($completed_items > 0) {
    status = 'partial'    // PO บางส่วน
} else {
    status = 'pending'    // PO รอ
}
```

---

## 5. ข้อมูลที่บันทึก

### ในตาราง `purchase_order_items`:
```sql
is_cancelled          -- 0 หรือ 1 (ยกเลิกทั้งหมด)
is_partially_cancelled -- 0 หรือ 1 (ยกเลิกบางส่วน)
cancel_qty_reason     -- จำนวนที่ยกเลิก
cancelled_by          -- user_id ผู้ยกเลิก
cancelled_at          -- datetime ที่ยกเลิก
cancel_reason         -- เหตุผล (supplier_shortage, etc.)
cancel_notes          -- หมายเหตุ
```

### ในตาราง `activity_logs`:
```sql
user_id     -- ผู้ยกเลิก
action      -- 'cancel_po_item'
description -- รายละเอียด (ยกเลิกจำนวนกี่หน่วย, เหตุผล)
created_at  -- เมื่อไร
```

### ใน `receive_items`:
สำหรับกรณี "ยกเลิกทั้งหมด" จะสร้าง receive record เพิ่มเติม:
```sql
receive_qty -- จำนวนที่เหลือ (เพื่อให้ครบจำนวนสั่ง)
remark      -- "ยกเลิกสินค้าจำนวนทั้งหมด"
```

---

## 6. ความตรวจสอบและการผิดพลาด

### ความตรวจสอบ Input:
1. **ประเภทการยกเลิก**: ต้องเลือก
2. **เหตุผล**: ต้องเลือก
3. **จำนวนที่ยกเลิก** (กรณี partial):
   - ต้อง > 0
   - ต้อง ≤ ปริมาณที่สั่ง
4. **PO และ Item**: ต้องมีอยู่

### ข้อความแสดงข้อผิดพลาด:
- "กรุณาเลือกประเภทการยกเลิก"
- "กรุณาเลือกเหตุผล"
- "จำนวนที่ยกเลิกต้องมากกว่า 0"
- "จำนวนที่ยกเลิกเกินจำนวนที่สั่ง"
- "ไม่พบรายการสินค้า"

---

## 7. ตัวอย่างการใช้งาน

### สถานการณ์ที่ 1: ผู้จำหน่ายไม่มีสินค้า (ยกเลิกทั้งหมด)
```
เหตุการณ์: สั่งสินค้า 100 หน่วย, รับ 10 หน่วย
ปัญหา: ผู้จำหน่ายประกาศไม่มีสินค้า

การจัดการ:
1. คลิก ❌ ยกเลิก
2. เลือก "ยกเลิกจำนวนทั้งหมด"
3. เลือก "ผู้จำหน่ายไม่มีสินค้า"
4. ยืนยัน

ผลลัพธ์:
- สร้าง receive: 90 หน่วย
- รับรวม: 10 + 90 = 100 ✅
- PO: Completed
- ไม่ค้าง
```

### สถานการณ์ที่ 2: ผู้จำหน่ายส่งสินค้าไม่ครบ (ยกเลิกบางส่วน)
```
เหตุการณ์: สั่งสินค้า 100 หน่วย, รับ 50 หน่วย
ปัญหา: ผู้จำหน่ายบอกว่าส่งได้เพียง 50 หน่วย

การจัดการ:
1. คลิก ❌ ยกเลิก
2. เลือก "ยกเลิกบางจำนวน"
3. กรอก "50" (จำนวนที่ยกเลิก)
4. เลือก "สินค้าไม่ครบตามจำนวนที่สั่ง"
5. ยืนยัน

ตรวจสอบ: 50 (รับ) + 50 (ยกเลิก) = 100 >= 100 ✅

ผลลัพธ์:
- PO: Completed
- ไม่ค้าง
```

### สถานการณ์ที่ 3: ยกเลิกส่วนหนึ่งแต่ยังรอส่วนที่เหลือ
```
เหตุการณ์: สั่ง 100, รับ 40 หน่วย
ปัญหา: ผู้จำหน่ายบอกว่า 30 หน่วยหาไม่ได้

การจัดการ:
1. คลิก ❌ ยกเลิก
2. เลือก "ยกเลิกบางจำนวน"
3. กรอก "30" (จำนวนที่ยกเลิก)
4. เลือก "สินค้าไม่ครบตามจำนวนที่สั่ง"
5. ยืนยัน

ตรวจสอบ: 40 (รับ) + 30 (ยกเลิก) = 70 < 100 ⚠️

ผลลัพธ์:
- PO: Partial (บางส่วน)
- ค้าง: 30 หน่วย (รอสินค้าส่วนที่เหลือ)
```

---

## 8. ฟิลด์และคำอธิบายเพิ่มเติม

### ประเภทการยกเลิก:
- **cancel_all**: ยกเลิกจำนวนทั้งหมดของรายการสินค้า
- **cancel_partial**: ยกเลิกเพียงส่วนหนึ่งของรายการสินค้า

### สถานะ PO:
- **pending**: รอการรับสินค้า
- **partial**: รับสินค้าบางส่วนเท่านั้น (หรือยกเลิกบางส่วน)
- **completed**: รับครบตามจำนวนที่สั่ง (หรือรับ + ยกเลิก = ครบ)

### สถานะของรายการสินค้า:
- **is_cancelled = 1**: ยกเลิกจำนวนทั้งหมด
- **is_partially_cancelled = 1**: ยกเลิกบางส่วน
- **cancel_qty_reason**: จำนวนที่ยกเลิก (สำหรับกรณี partial)

---

## 9. การทดสอบ

### Test Case 1: ยกเลิกทั้งหมด
```
✓ คลิกปุ่มยกเลิก
✓ เลือก "ยกเลิกจำนวนทั้งหมด"
✓ เลือกเหตุผล
✓ ยืนยัน
✓ ตรวจสอบ: PO status = 'completed'
✓ ตรวจสอบ: is_cancelled = 1
✓ ตรวจสอบ: receive_items มี record ใหม่
```

### Test Case 2: ยกเลิกบางส่วน (ครบตามจำนวน)
```
✓ คลิกปุ่มยกเลิก
✓ เลือก "ยกเลิกบางจำนวน"
✓ กรอกจำนวน
✓ เลือกเหตุผล
✓ ยืนยัน
✓ ตรวจสอบ: PO status = 'completed' (ถ้า received + cancel >= ordered)
✓ ตรวจสอบ: is_partially_cancelled = 1
✓ ตรวจสอบ: cancel_qty_reason = value
```

### Test Case 3: ยกเลิกบางส่วน (ยังไม่ครบ)
```
✓ คลิกปุ่มยกเลิก
✓ เลือก "ยกเลิกบางจำนวน"
✓ กรอกจำนวนน้อยกว่า (ordered - received)
✓ เลือกเหตุผล
✓ ยืนยัน
✓ ตรวจสอบ: PO status = 'partial'
✓ ตรวจสอบ: is_partially_cancelled = 1
```

### Test Case 4: ความตรวจสอบ Input
```
✓ ไม่เลือก "ประเภทการยกเลิก" → แสดง error
✓ ไม่เลือก "เหตุผล" → แสดง error
✓ กรอกจำนวน ≤ 0 → แสดง error
✓ กรอกจำนวน > ordered_qty → แสดง error
```

---

## 10. สรุปการเปลี่ยนแปลง

### ไฟล์ที่แก้ไข:
1. **receive_po_items.php**
   - เพิ่ม radio buttons สำหรับเลือก "ยกเลิกทั้งหมด" / "ยกเลิกบางส่วน"
   - เพิ่ม input field สำหรับกรอกจำนวนที่ยกเลิก
   - เพิ่ม event handler สำหรับแสดง/ซ่อน quantity input
   - อัปเดต `showCancelItemModal()` รับ ordered_qty และ received_qty
   - อัปเดต `saveCancelItem()` ส่ง cancel_type และ cancel_qty

2. **process_receive_po.php**
   - เพิ่มคอลัมน์: `is_partially_cancelled`, `cancel_qty_reason`
   - อัปเดต `initializeCancelSchema()` เพิ่มคอลัมน์ใหม่
   - อัปเดต cancel_item action จัดการ 2 กรณี
   - อัปเดต `updatePOStatus()` คำนึงถึง cancel_qty_reason

### ความเข้ากันได้:
- ✅ ความเข้ากันได้แบบย้อนหลังกับรหัสเก่า
- ✅ ไม่มีการลบข้อมูลเก่า
- ✅ รองรับ cancel_all โดยไม่บังคับ cancel_qty

---

## 11. คำถามที่พบบ่อย (FAQ)

**Q: ถ้าเลือก "ยกเลิกจำนวนทั้งหมด" จะเกิดอะไร?**  
A: ระบบจะสร้าง receive record ด้วยจำนวนที่เหลือ เพื่อให้ครบตามจำนวนที่สั่ง และปิด PO เป็น 100%

**Q: ถ้า received + cancel > ordered ได้ไหม?**  
A: ไม่ได้ ระบบจะตรวจสอบว่า cancel_qty ≤ ordered_qty และไม่เกินจำนวนที่สั่ง

**Q: ยกเลิกจำนวนบางส่วน แต่ยังไม่ครบจำนวนสั่ง จะเกิดอะไร?**  
A: PO จะยังคงเป็น "Partial" และสินค้ายังคงค้างในระบบ

**Q: สามารถยกเลิกได้หลายครั้งหรือไม่?**  
A: ได้ สามารถยกเลิกบางส่วนหลายครั้งจนกว่า (received + cancelled) >= ordered

**Q: บันทึกอะไรในฐานข้อมูล?**  
A: บันทึก: ประเภทการยกเลิก, จำนวน, เหตุผล, หมายเหตุ, ผู้ยกเลิก, วันเวลา

---

## 12. ข้อสำคัญ

⚠️ **หมายเหตุสำคัญ:**
1. เมื่อเลือก "ยกเลิกทั้งหมด" ไม่ต้องกรอกจำนวน ระบบจะใช้จำนวนที่สั่งโดยอัตโนมัติ
2. เมื่อเลือก "ยกเลิกบางส่วน" ต้องกรอกจำนวนให้ชัดเจน
3. การยกเลิกจะบันทึกและไม่สามารถยกเลิกการยกเลิกได้
4. ระบบจะอัปเดตสถานะ PO โดยอัตโนมัติตามสูตร: received + cancelled >= ordered
5. สามารถดูประวัติการยกเลิกใน activity_logs

---

**เวอร์ชัน**: 1.0  
**วันที่อัปเดต**: December 3, 2025  
**สถานะ**: ✅ พร้อมใช้งาน
