<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>ทดสอบ Popup แก้ไข</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; }
        .test-section { margin: 2rem 0; padding: 1rem; border: 1px solid #ddd; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="container py-4">
        <h1 class="mb-4">ทดสอบ Popup แก้ไขข้อมูล</h1>
        
        <div class="test-section">
            <h3>การทดสอบ:</h3>
            <div class="row">
                <div class="col-md-6">
                    <label class="form-label">เลือก receive_id สำหรับทดสอบ:</label>
                    <select class="form-select" id="test-receive-id">
                        <option value="1">ID 1</option>
                        <option value="2">ID 2</option>
                        <option value="3">ID 3</option>
                        <option value="4">ID 4</option>
                        <option value="5">ID 5</option>
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-primary d-block" onclick="testEditForm()">
                        <span class="material-icons">edit</span>
                        ทดสอบแสดงฟอร์มแก้ไข
                    </button>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ผลการทดสอบ:</h3>
            <div id="test-results"></div>
        </div>
    </div>

    <!-- Modal แก้ไข (คัดลอกจากไฟล์หลัก) -->
    <div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editModalLabel">แก้ไขรายการรับสินค้า</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-form">
                        <input type="hidden" name="receive_id" id="edit-receive-id">
                        <div class="mb-2">
                            <label for="edit-remark" class="form-label">หมายเหตุ</label>
                            <input type="text" class="form-control" name="remark" id="edit-remark">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">ตำแหน่ง</label>
                            <div class="row g-2">
                                <div class="col-4">
                                    <select class="form-select" name="row_code" id="edit-row-code">
                                        <option value="">แถว</option>
                                        <?php
                                        foreach (range('A','X') as $c) {
                                            echo '<option value="'.$c.'">'.$c.'</option>';
                                        }
                                        ?>
                                        <option value="T">T(ตู้)</option>
                                        <option value="sale(บน)">sale(บน)</option>
                                        <option value="sale(ล่าง)">sale(ล่าง)</option>
                                    </select>
                                </div>
                                <div class="col-4">
                                    <select class="form-select" name="bin" id="edit-bin">
                                        <option value="">ล๊อค</option>
                                        <?php for($i=1;$i<=10;$i++) echo '<option value="'.$i.'">'.$i.'</option>'; ?>
                                    </select>
                                </div>
                                <div class="col-4">
                                    <select class="form-select" name="shelf" id="edit-shelf">
                                        <option value="">ชั้น</option>
                                        <?php for($i=1;$i<=10;$i++) echo '<option value="'.$i.'">'.$i.'</option>'; ?>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-2">
                            <label for="edit-price-cost" class="form-label">ราคาต้นทุน</label>
                            <input type="number" step="0.01" class="form-control" name="price_per_unit" id="edit-price-cost">
                        </div>
                        <div class="mb-2">
                            <label for="edit-price-sale" class="form-label">ราคาขายออก</label>
                            <input type="number" step="0.01" class="form-control" name="sale_price" id="edit-price-sale">
                        </div>
                        <div class="mb-2">
                            <label class="form-label">ประเภทการเปลี่ยนแปลง</label>
                            <select class="form-select" id="edit-qty-type">
                                <option value="plus">เพิ่ม</option>
                                <option value="minus">ลด</option>
                            </select>
                        </div>
                        <div class="mb-2">
                            <label for="edit-receive-qty" class="form-label">จำนวน</label>
                            <input type="number" class="form-control" name="receive_qty" id="edit-receive-qty">
                        </div>
                        <div class="mb-2">
                            <label for="edit-po-number" class="form-label">เลข PO</label>
                            <div class="input-group">
                                <input type="text" class="form-control" name="po_number" id="edit-po-number" readonly>
                                <button type="button" class="btn btn-outline-secondary" id="change-po-btn">
                                    <span class="material-icons" style="font-size: 1rem;">search</span>
                                    เปลี่ยน
                                </button>
                            </div>
                            <input type="hidden" name="po_id" id="edit-po-id">
                            <input type="hidden" name="item_id" id="edit-item-id">
                        </div>
                        <div class="mb-2">
                            <label for="edit-expiry-date" class="form-label">วันหมดอายุ</label>
                            <input type="date" class="form-control" name="expiry_date" id="edit-expiry-date">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ยกเลิก</button>
                    <button type="button" class="btn btn-primary" id="save-edit">บันทึก</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        function testEditForm() {
            const receiveId = $('#test-receive-id').val();
            
            // ล้างผลการทดสอบก่อน
            $('#test-results').html('<div class="spinner-border" role="status"><span class="visually-hidden">Loading...</span></div>');
            
            // เซ็ตค่าเริ่มต้น
            $('#edit-receive-id').val(receiveId);
            $('#edit-qty-type').val('plus');
            $('#edit-receive-qty').val('10');
            $('#edit-po-number').val('PO-' + receiveId);
            
            // ล้างค่าอื่นๆ
            $('#edit-row-code').val('');
            $('#edit-bin').val('');
            $('#edit-shelf').val('');
            $('#edit-price-cost').val('');
            $('#edit-price-sale').val('');
            $('#edit-remark').val('');
            $('#edit-expiry-date').val('');
            
            // เรียก API
            $.get('../api/receive_position_api.php', { receive_id: receiveId })
                .done(function(response) {
                    console.log('API Response:', response);
                    
                    let resultHtml = '<div class="alert alert-info">ผลการเรียก API:</div>';
                    
                    if (response.success) {
                        // เซ็ตค่าในฟอร์ม
                        let rowCode = response.row_code || '';
                        let bin = response.bin || '';
                        let shelf = response.shelf || '';
                        let priceCost = response.price_per_unit || '';
                        let priceSale = response.sale_price || '';
                        let remarkFromAPI = response.remark || '';
                        let expiryFromAPI = response.expiry_date || '';
                        
                        // ฟังก์ชันเพิ่ม option ถ้าไม่มี
                        function setSelectWithDynamicOption(sel, val) {
                            val = (val || '').toString().trim();
                            if(val && sel.find('option[value="'+val+'"]').length === 0) {
                                sel.append('<option value="'+val+'">'+val+'</option>');
                            }
                            sel.val(val).trigger('change');
                        }
                        
                        setSelectWithDynamicOption($('#edit-row-code'), rowCode);
                        setSelectWithDynamicOption($('#edit-bin'), bin);
                        setSelectWithDynamicOption($('#edit-shelf'), shelf);
                        
                        $('#edit-price-cost').val(priceCost);
                        $('#edit-price-sale').val(priceSale);
                        $('#edit-remark').val(remarkFromAPI);
                        
                        if (expiryFromAPI) {
                            $('#edit-expiry-date').val(expiryFromAPI);
                        }
                        
                        // แสดงผลลัพธ์
                        resultHtml += '<div class="row">';
                        resultHtml += '<div class="col-md-6">';
                        resultHtml += '<h6>ข้อมูลจาก API:</h6>';
                        resultHtml += '<ul>';
                        resultHtml += '<li>แถว: ' + (rowCode || 'ไม่มี') + '</li>';
                        resultHtml += '<li>ล๊อค: ' + (bin || 'ไม่มี') + '</li>';
                        resultHtml += '<li>ชั้น: ' + (shelf || 'ไม่มี') + '</li>';
                        resultHtml += '<li>ราคาต้นทุน: ' + (priceCost || 'ไม่มี') + '</li>';
                        resultHtml += '<li>ราคาขาย: ' + (priceSale || 'ไม่มี') + '</li>';
                        resultHtml += '<li>หมายเหตุ: ' + (remarkFromAPI || 'ไม่มี') + '</li>';
                        resultHtml += '<li>วันหมดอายุ: ' + (expiryFromAPI || 'ไม่มี') + '</li>';
                        resultHtml += '</ul>';
                        resultHtml += '</div>';
                        resultHtml += '<div class="col-md-6">';
                        resultHtml += '<h6>ค่าในฟอร์ม:</h6>';
                        resultHtml += '<ul>';
                        resultHtml += '<li>แถว: ' + $('#edit-row-code').val() + '</li>';
                        resultHtml += '<li>ล๊อค: ' + $('#edit-bin').val() + '</li>';
                        resultHtml += '<li>ชั้น: ' + $('#edit-shelf').val() + '</li>';
                        resultHtml += '<li>ราคาต้นทุน: ' + $('#edit-price-cost').val() + '</li>';
                        resultHtml += '<li>ราคาขาย: ' + $('#edit-price-sale').val() + '</li>';
                        resultHtml += '<li>หมายเหตุ: ' + $('#edit-remark').val() + '</li>';
                        resultHtml += '<li>วันหมดอายุ: ' + $('#edit-expiry-date').val() + '</li>';
                        resultHtml += '</ul>';
                        resultHtml += '</div>';
                        resultHtml += '</div>';
                        
                        resultHtml += '<div class="mt-3">';
                        resultHtml += '<button class="btn btn-success" onclick="showModal()">แสดงฟอร์มแก้ไข</button>';
                        resultHtml += '</div>';
                    } else {
                        resultHtml += '<div class="alert alert-danger">API Error: ' + (response.msg || 'ไม่ทราบสาเหตุ') + '</div>';
                    }
                    
                    $('#test-results').html(resultHtml);
                })
                .fail(function(xhr, status, error) {
                    console.error('API Error:', xhr, status, error);
                    $('#test-results').html('<div class="alert alert-danger">ข้อผิดพลาด: ' + error + '</div>');
                });
        }
        
        function showModal() {
            var modal = new bootstrap.Modal(document.getElementById('editModal'));
            modal.show();
        }
        
        $(document).ready(function() {
            // ทดสอบทันทีเมื่อโหลดหน้า
            testEditForm();
        });
    </script>
</body>
</html>