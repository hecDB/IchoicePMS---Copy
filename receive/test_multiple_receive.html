<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <title>ทดสอบการรับสินค้าหลายรายการ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; background: #f8fafc; }
        .test-section { background: white; border-radius: 12px; padding: 2rem; margin-bottom: 2rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .btn-test { margin: 0.5rem; }
        .result-box { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 1rem; margin-top: 1rem; }
        .log-item { padding: 0.5rem; border-bottom: 1px solid #eee; font-family: monospace; font-size: 0.875rem; }
    </style>
</head>
<body>
<div class="container py-4">
    <h1 class="mb-4">
        <span class="material-icons align-middle me-2">bug_report</span>
        ทดสอบการรับสินค้าหลายรายการ
    </h1>

    <!-- Test Section 1: API Test -->
    <div class="test-section">
        <h3><span class="material-icons align-middle me-2">api</span>ทดสอบ API รายการสินค้า</h3>
        <p>ทดสอบการเรียก API เพื่อดึงรายการสินค้าจาก PO</p>
        
        <div class="mb-3">
            <label class="form-label">PO ID:</label>
            <input type="number" id="testPoId" class="form-control" value="6" style="width: 120px; display: inline-block;">
            <button class="btn btn-primary btn-test" onclick="testGetPoItems()">
                <span class="material-icons me-1">list</span>
                ทดสอบดึงรายการ
            </button>
        </div>
        
        <div class="result-box" id="apiResult" style="display: none;"></div>
    </div>

    <!-- Test Section 2: Single Receive Test -->
    <div class="test-section">
        <h3><span class="material-icons align-middle me-2">input</span>ทดสอบรับสินค้ารายการเดียว</h3>
        <p>ทดสอบการรับสินค้ารายการเดียว</p>
        
        <div class="row mb-3">
            <div class="col-md-3">
                <label class="form-label">PO ID:</label>
                <input type="number" id="singlePoId" class="form-control" value="6">
            </div>
            <div class="col-md-3">
                <label class="form-label">Item ID:</label>
                <input type="number" id="singleItemId" class="form-control" value="60">
            </div>
            <div class="col-md-3">
                <label class="form-label">จำนวน:</label>
                <input type="number" id="singleQuantity" class="form-control" value="1" step="0.01">
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button class="btn btn-success btn-test" onclick="testSingleReceive()">
                    <span class="material-icons me-1">check</span>
                    ทดสอบรับเดี่ยว
                </button>
            </div>
        </div>
        
        <div class="result-box" id="singleResult" style="display: none;"></div>
    </div>

    <!-- Test Section 3: Multiple Receive Test -->
    <div class="test-section">
        <h3><span class="material-icons align-middle me-2">playlist_add_check</span>ทดสอบรับสินค้าหลายรายการ</h3>
        <p>ทดสอบการรับสินค้าหลายรายการพร้อมกัน</p>
        
        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label">PO ID:</label>
                <input type="number" id="multiPoId" class="form-control" value="6">
            </div>
            <div class="col-md-8 d-flex align-items-end">
                <button class="btn btn-warning btn-test" onclick="testMultipleReceive()">
                    <span class="material-icons me-1">playlist_add_check</span>
                    ทดสอบรับหลายรายการ
                </button>
                <button class="btn btn-info btn-test ms-2" onclick="loadItemsForMultiple()">
                    <span class="material-icons me-1">refresh</span>
                    โหลดรายการ
                </button>
            </div>
        </div>

        <div id="multipleItemsContainer" style="display: none;">
            <h5>รายการสินค้าที่สามารถรับได้:</h5>
            <div id="multipleItemsList"></div>
            <button class="btn btn-success mt-3" onclick="processMultipleReceive()">
                <span class="material-icons me-1">save</span>
                ดำเนินการรับสินค้า
            </button>
        </div>
        
        <div class="result-box" id="multipleResult" style="display: none;"></div>
    </div>

    <!-- Test Section 4: Database Check -->
    <div class="test-section">
        <h3><span class="material-icons align-middle me-2">storage</span>ทดสอบข้อมูลฐานข้อมูล</h3>
        <p>ตรวจสอบข้อมูลในฐานข้อมูล</p>
        
        <div class="row mb-3">
            <div class="col-md-4">
                <label class="form-label">PO ID:</label>
                <input type="number" id="dbPoId" class="form-control" value="6">
            </div>
            <div class="col-md-8 d-flex align-items-end">
                <button class="btn btn-secondary btn-test" onclick="checkPOItems()">
                    <span class="material-icons me-1">table_view</span>
                    ตรวจสอบรายการ PO
                </button>
                <button class="btn btn-secondary btn-test ms-2" onclick="checkReceivedItems()">
                    <span class="material-icons me-1">check_circle</span>
                    ตรวจสอบการรับแล้ว
                </button>
            </div>
        </div>
        
        <div class="result-box" id="dbResult" style="display: none;"></div>
    </div>

    <!-- Log Section -->
    <div class="test-section">
        <h3><span class="material-icons align-middle me-2">terminal</span>Log การทำงาน</h3>
        <div class="result-box">
            <div id="logContainer">
                <div class="log-item">พร้อมเริ่มการทดสอบ...</div>
            </div>
            <button class="btn btn-sm btn-outline-secondary mt-2" onclick="clearLog()">ล้าง Log</button>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
// Utility Functions
function addLog(message, type = 'info') {
    const timestamp = new Date().toLocaleTimeString();
    const colorClass = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : 'text-dark';
    $('#logContainer').append(`<div class="log-item ${colorClass}">[${timestamp}] ${message}</div>`);
    $('#logContainer').scrollTop($('#logContainer')[0].scrollHeight);
}

function clearLog() {
    $('#logContainer').html('<div class="log-item">Log ถูกล้างแล้ว...</div>');
}

function showResult(containerId, content, isError = false) {
    const container = $(`#${containerId}`);
    container.html(content).show();
    if (isError) {
        container.addClass('border-danger').removeClass('border-success');
    } else {
        container.addClass('border-success').removeClass('border-danger');
    }
}

// Test Functions
function testGetPoItems() {
    const poId = $('#testPoId').val();
    addLog(`เริ่มทดสอบดึงรายการสินค้า PO ID: ${poId}`);
    
    $.ajax({
        url: '../api/get_po_items.php',
        method: 'GET',
        data: { po_id: poId },
        dataType: 'json',
        success: function(response) {
            addLog('API Response ได้รับแล้ว', 'success');
            let html = '<h5>ผลลัพธ์ API:</h5>';
            html += `<p><strong>Success:</strong> ${response.success}</p>`;
            
            if (response.success && response.items) {
                html += `<p><strong>จำนวนรายการ:</strong> ${response.items.length}</p>`;
                html += '<table class="table table-sm"><thead><tr><th>Item ID</th><th>สินค้า</th><th>สั่ง</th><th>รับแล้ว</th><th>คงเหลือ</th></tr></thead><tbody>';
                
                response.items.forEach(item => {
                    html += `<tr>
                        <td>${item.item_id}</td>
                        <td>${item.product_name}</td>
                        <td>${item.order_qty}</td>
                        <td>${item.received_qty}</td>
                        <td>${item.remaining_qty}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
            } else if (response.error) {
                html += `<p class="text-danger"><strong>Error:</strong> ${response.error}</p>`;
            }
            
            showResult('apiResult', html);
        },
        error: function(xhr, status, error) {
            addLog(`API Error: ${error}`, 'error');
            showResult('apiResult', `<p class="text-danger">เกิดข้อผิดพลาด: ${error}</p>`, true);
        }
    });
}

function testSingleReceive() {
    const poId = $('#singlePoId').val();
    const itemId = $('#singleItemId').val();
    const quantity = $('#singleQuantity').val();
    
    addLog(`เริ่มทดสอบรับสินค้าเดี่ยว: PO ${poId}, Item ${itemId}, จำนวน ${quantity}`);
    
    $.ajax({
        url: 'process_receive_po.php',
        method: 'POST',
        data: {
            action: 'receive_single',
            po_id: poId,
            item_id: itemId,
            quantity: quantity,
            notes: 'ทดสอบจากระบบ Test'
        },
        dataType: 'json',
        success: function(response) {
            addLog('Single Receive Response ได้รับแล้ว', response.success ? 'success' : 'error');
            let html = '<h5>ผลลัพธ์การรับสินค้าเดี่ยว:</h5>';
            html += `<p><strong>Success:</strong> ${response.success}</p>`;
            html += `<p><strong>Message:</strong> ${response.message}</p>`;
            
            showResult('singleResult', html, !response.success);
        },
        error: function(xhr, status, error) {
            addLog(`Single Receive Error: ${error}`, 'error');
            showResult('singleResult', `<p class="text-danger">เกิดข้อผิดพลาด: ${error}</p>`, true);
        }
    });
}

let availableItems = [];

function loadItemsForMultiple() {
    const poId = $('#multiPoId').val();
    addLog(`โหลดรายการสินค้าสำหรับ PO ${poId}`);
    
    $.ajax({
        url: '../api/get_po_items.php',
        method: 'GET',
        data: { po_id: poId },
        dataType: 'json',
        success: function(response) {
            if (response.success && response.items) {
                availableItems = response.items.filter(item => parseFloat(item.remaining_qty.replace(/,/g, '')) > 0);
                
                let html = '';
                availableItems.forEach((item, index) => {
                    const remainingQty = parseFloat(item.remaining_qty.replace(/,/g, ''));
                    html += `
                        <div class="border rounded p-2 mb-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="item_${item.item_id}" checked>
                                <label class="form-check-label" for="item_${item.item_id}">
                                    <strong>${item.product_name}</strong> - คงเหลือ: ${item.remaining_qty}
                                </label>
                            </div>
                            <div class="mt-2">
                                <label class="form-label">จำนวนที่จะรับ:</label>
                                <input type="number" class="form-control form-control-sm" 
                                       id="qty_${item.item_id}" 
                                       value="${Math.min(1, remainingQty)}" 
                                       max="${remainingQty}" 
                                       min="0.01" step="0.01" style="width: 120px;">
                            </div>
                        </div>
                    `;
                });
                
                $('#multipleItemsList').html(html);
                $('#multipleItemsContainer').show();
                addLog(`พบรายการที่สามารถรับได้ ${availableItems.length} รายการ`, 'success');
            }
        },
        error: function(xhr, status, error) {
            addLog(`Load Items Error: ${error}`, 'error');
        }
    });
}

function processMultipleReceive() {
    const poId = $('#multiPoId').val();
    const items = [];
    
    availableItems.forEach(item => {
        if ($(`#item_${item.item_id}`).is(':checked')) {
            const quantity = parseFloat($(`#qty_${item.item_id}`).val()) || 0;
            if (quantity > 0) {
                items.push({
                    item_id: item.item_id,
                    quantity: quantity
                });
            }
        }
    });
    
    if (items.length === 0) {
        addLog('ไม่มีรายการที่จะรับ', 'error');
        return;
    }
    
    addLog(`เริ่มทดสอบรับสินค้าหลายรายการ: ${items.length} รายการ`);
    
    $.ajax({
        url: 'process_receive_po.php',
        method: 'POST',
        data: {
            action: 'receive_multiple',
            po_id: poId,
            items: JSON.stringify(items)
        },
        dataType: 'json',
        success: function(response) {
            addLog('Multiple Receive Response ได้รับแล้ว', response.success ? 'success' : 'error');
            let html = '<h5>ผลลัพธ์การรับสินค้าหลายรายการ:</h5>';
            html += `<p><strong>Success:</strong> ${response.success}</p>`;
            html += `<p><strong>Message:</strong> ${response.message}</p>`;
            html += `<p><strong>รายการที่ส่ง:</strong> ${items.length} รายการ</p>`;
            
            showResult('multipleResult', html, !response.success);
        },
        error: function(xhr, status, error) {
            addLog(`Multiple Receive Error: ${error}`, 'error');
            showResult('multipleResult', `<p class="text-danger">เกิดข้อผิดพลาด: ${error}</p>`, true);
        }
    });
}

function testMultipleReceive() {
    loadItemsForMultiple();
}

function checkPOItems() {
    const poId = $('#dbPoId').val();
    addLog(`ตรวจสอบรายการ PO ${poId} ในฐานข้อมูล`);
    
    $.ajax({
        url: 'test_db_api.php',
        method: 'GET',
        data: { action: 'check_po_items', po_id: poId },
        dataType: 'json',
        success: function(response) {
            let html = '<h5>รายการ PO Items:</h5>';
            if (response.success && response.data) {
                html += `<p><strong>จำนวนรายการ:</strong> ${response.count}</p>`;
                html += '<table class="table table-sm"><thead><tr><th>Item ID</th><th>สินค้า</th><th>สั่ง</th><th>รับแล้ว</th><th>คงเหลือ</th><th>สกุลเงิน</th></tr></thead><tbody>';
                
                response.data.forEach(item => {
                    html += `<tr>
                        <td>${item.item_id}</td>
                        <td>${item.product_name}</td>
                        <td>${item.order_qty}</td>
                        <td>${item.received_qty}</td>
                        <td>${item.remaining_qty}</td>
                        <td>${item.currency || 'N/A'}</td>
                    </tr>`;
                });
                
                html += '</tbody></table>';
            } else {
                html += `<p class="text-danger">Error: ${response.error}</p>`;
            }
            
            showResult('dbResult', html);
            addLog('ตรวจสอบรายการ PO เสร็จสิ้น', 'success');
        },
        error: function(xhr, status, error) {
            addLog(`Check PO Items Error: ${error}`, 'error');
            showResult('dbResult', `<p class="text-danger">เกิดข้อผิดพลาด: ${error}</p>`, true);
        }
    });
}

function checkReceivedItems() {
    const poId = $('#dbPoId').val();
    addLog(`ตรวจสอบรายการที่รับแล้วสำหรับ PO ${poId}`);
    
    $.ajax({
        url: 'test_db_api.php',
        method: 'GET',
        data: { action: 'check_received_items', po_id: poId },
        dataType: 'json',
        success: function(response) {
            let html = '<h5>รายการที่รับแล้ว:</h5>';
            if (response.success && response.data) {
                html += `<p><strong>จำนวนการรับ:</strong> ${response.count} ครั้ง</p>`;
                
                if (response.count > 0) {
                    html += '<table class="table table-sm"><thead><tr><th>Receive ID</th><th>Item ID</th><th>สินค้า</th><th>จำนวนรับ</th><th>วันที่รับ</th><th>หมายเหตุ</th></tr></thead><tbody>';
                    
                    response.data.forEach(item => {
                        html += `<tr>
                            <td>${item.receive_id}</td>
                            <td>${item.item_id}</td>
                            <td>${item.product_name}</td>
                            <td>${item.receive_qty}</td>
                            <td>${new Date(item.created_at).toLocaleString('th-TH')}</td>
                            <td>${item.remark || '-'}</td>
                        </tr>`;
                    });
                    
                    html += '</tbody></table>';
                } else {
                    html += '<p class="text-muted">ยังไม่มีการรับสินค้า</p>';
                }
            } else {
                html += `<p class="text-danger">Error: ${response.error}</p>`;
            }
            
            showResult('dbResult', html);
            addLog('ตรวจสอบรายการที่รับแล้วเสร็จสิ้น', 'success');
        },
        error: function(xhr, status, error) {
            addLog(`Check Received Items Error: ${error}`, 'error');
            showResult('dbResult', `<p class="text-danger">เกิดข้อผิดพลาด: ${error}</p>`, true);
        }
    });
}
</script>

</body>
</html>